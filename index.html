<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentforce Script Review: RestaurantScriptAgent3</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --border: #2a2a3a;
            --text-primary: #e8e8ec;
            --text-secondary: #8888a0;
            --text-muted: #55556a;
            --accent-red: #ff4757;
            --accent-red-glow: rgba(255, 71, 87, 0.3);
            --accent-orange: #ffa502;
            --accent-orange-glow: rgba(255, 165, 2, 0.3);
            --accent-yellow: #ffdd59;
            --accent-blue: #3742fa;
            --accent-cyan: #00d2d3;
            --accent-green: #26de81;
            --accent-green-glow: rgba(38, 222, 129, 0.3);
            --gradient-hero: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 16px;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        .hero {
            background: var(--gradient-hero);
            padding: 80px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid var(--border);
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 71, 87, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 210, 211, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .hero-badge {
            display: inline-block;
            background: rgba(38, 222, 129, 0.15);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-bottom: 24px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 var(--accent-green-glow); }
            50% { box-shadow: 0 0 20px 5px var(--accent-green-glow); }
        }

        .hero h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-cyan) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-subtitle { font-size: 1.25rem; color: var(--text-secondary); max-width: 600px; margin: 0 auto 32px; }
        .hero-meta { display: flex; justify-content: center; gap: 32px; flex-wrap: wrap; font-size: 14px; color: var(--text-muted); }
        .hero-meta span { display: flex; align-items: center; gap: 8px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 60px 24px; }
        .section-header { margin-bottom: 40px; }
        .section-header h2 { font-size: 2rem; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
        .section-header p { color: var(--text-secondary); font-size: 1.1rem; }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 60px; }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .summary-card.bug::before { background: var(--accent-red); }
        .summary-card.risk::before { background: var(--accent-orange); }
        .summary-card.style::before { background: var(--accent-cyan); }

        .summary-card:hover { transform: translateY(-4px); border-color: var(--text-muted); }

        .summary-card .count { font-size: 3.5rem; font-weight: 700; line-height: 1; margin-bottom: 8px; }
        .summary-card.bug .count { color: var(--accent-red); }
        .summary-card.risk .count { color: var(--accent-orange); }
        .summary-card.style .count { color: var(--accent-cyan); }

        .summary-card .label { font-size: 14px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .summary-card .sublabel { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

        .issues-section { margin-bottom: 60px; }

        .issue-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 24px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .issue-card:hover { border-color: var(--text-muted); }

        .issue-header {
            padding: 24px 28px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            border-bottom: 1px solid var(--border);
        }

        .issue-badge {
            flex-shrink: 0;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .issue-badge.bug { background: rgba(255, 71, 87, 0.15); color: var(--accent-red); border: 1px solid var(--accent-red); }
        .issue-badge.risk { background: rgba(255, 165, 2, 0.15); color: var(--accent-orange); border: 1px solid var(--accent-orange); }
        .issue-badge.style { background: rgba(0, 210, 211, 0.15); color: var(--accent-cyan); border: 1px solid var(--accent-cyan); }

        .issue-title { flex: 1; }
        .issue-title h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 4px; }
        .issue-title .location { font-size: 13px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }

        .issue-content { padding: 28px; }
        .issue-content p { margin-bottom: 16px; color: var(--text-secondary); }
        .issue-content strong { color: var(--text-primary); }

        pre {
            background: #0d0d12;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
            margin: 16px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        pre code { background: none; padding: 0; }
        .code-comment { color: #6a6a7a; }
        .code-keyword { color: var(--accent-cyan); }
        .code-string { color: var(--accent-green); }
        .code-variable { color: var(--accent-orange); }

        .fix-box {
            background: rgba(38, 222, 129, 0.08);
            border: 1px solid rgba(38, 222, 129, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
        }

        .fix-box h4 { color: var(--accent-green); font-size: 14px; font-weight: 600; margin-bottom: 12px; }

        .alternatives-box {
            background: rgba(55, 66, 250, 0.08);
            border: 1px solid rgba(55, 66, 250, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
        }

        .alternatives-box h4 { color: var(--accent-blue); font-size: 14px; font-weight: 600; margin-bottom: 12px; }

        .callout {
            background: rgba(255, 165, 2, 0.08);
            border: 1px solid rgba(255, 165, 2, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .callout h4 { color: var(--accent-orange); font-size: 14px; font-weight: 600; margin-bottom: 8px; }
        .callout p { color: var(--text-secondary); margin: 0; font-size: 14px; }

        .info-notice {
            background: linear-gradient(135deg, rgba(55, 66, 250, 0.1) 0%, rgba(0, 210, 211, 0.1) 100%);
            border: 1px solid rgba(55, 66, 250, 0.3);
            border-radius: 16px;
            padding: 24px 28px;
            margin-bottom: 40px;
        }

        .info-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .info-icon { font-size: 24px; }
        .info-header h3 { color: var(--accent-cyan); font-size: 1.1rem; font-weight: 600; }
        .info-notice p { color: var(--text-secondary); margin-bottom: 16px; }
        .info-notice ul { list-style: none; }
        .info-notice li { padding: 8px 0; color: var(--text-secondary); border-bottom: 1px solid rgba(255, 255, 255, 0.05); font-size: 14px; }
        .info-notice li:last-child { border-bottom: none; }
        .info-notice li strong { color: var(--text-primary); }

        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .tab:hover { color: var(--text-primary); }
        .tab.active { background: var(--accent-blue); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .diagram-section { margin: 60px 0; }

        .diagram-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            overflow-x: auto;
        }

        .diagram-container .mermaid { display: flex; justify-content: center; }

        .positive-section {
            background: rgba(38, 222, 129, 0.05);
            border: 1px solid rgba(38, 222, 129, 0.2);
            border-radius: 16px;
            padding: 32px;
            margin: 60px 0;
        }

        .positive-section h3 { color: var(--accent-green); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .positive-list { list-style: none; }
        .positive-list li { padding: 12px 0; border-bottom: 1px solid rgba(38, 222, 129, 0.1); display: flex; align-items: flex-start; gap: 12px; color: var(--text-secondary); }
        .positive-list li:last-child { border-bottom: none; }
        .positive-list li::before { content: '‚úì'; color: var(--accent-green); font-weight: bold; }

        .solution-section {
            background: linear-gradient(135deg, rgba(38, 222, 129, 0.08) 0%, rgba(0, 210, 211, 0.08) 100%);
            border: 1px solid rgba(38, 222, 129, 0.3);
            border-radius: 20px;
            padding: 40px;
            margin-top: 20px;
        }

        .solution-header { margin-bottom: 32px; }
        .solution-header h3 { color: var(--accent-green); font-size: 1.5rem; margin-bottom: 8px; font-family: 'JetBrains Mono', monospace; }
        .solution-header p { color: var(--text-secondary); }

        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 32px; }

        .feature-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .feature-icon { font-size: 20px; flex-shrink: 0; }
        .feature-text { display: flex; flex-direction: column; gap: 4px; }
        .feature-text strong { color: var(--text-primary); font-size: 14px; }
        .feature-text span { color: var(--text-muted); font-size: 13px; }

        .code-section {
            background: #0a0a0f;
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .code-header {
            background: var(--bg-card);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .code-header span { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-secondary); }

        .copy-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            transition: all 0.2s ease;
        }

        .copy-btn:hover { background: #4c54ff; }

        .code-section pre { margin: 0; padding: 24px; max-height: 600px; overflow: auto; border: none; border-radius: 0; }
        .code-section code { background: none; padding: 0; font-size: 12px; line-height: 1.5; color: var(--text-secondary); }

        .footer {
            text-align: center;
            padding: 40px;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 14px;
        }

        .footer a { color: var(--accent-cyan); text-decoration: none; }

        @media (max-width: 768px) {
            .hero { padding: 60px 20px; }
            .container { padding: 40px 16px; }
            .hero-meta { flex-direction: column; gap: 12px; }
        }
    </style>
</head>
<body>
    <header class="hero">
        <div class="hero-badge">‚úÖ Verified Against SF Docs</div>
        <h1>Agentforce Script Review</h1>
        <p class="hero-subtitle">RestaurantScriptAgent3 ‚Äî OpenTable Support Agent</p>
        <div class="hero-meta">
            <span>üìÖ Reviewed: 15 January 2026</span>
            <span>‚úÖ Documentation Verified</span>
            <span>üìÑ 480 Lines Analyzed</span>
        </div>
    </header>

    <section class="container">
        <div class="section-header">
            <h2>üìä Issue Summary</h2>
            <p>Categorized by type: Bugs (must fix), Risks (should address), Style (consider)</p>
        </div>

        <div class="summary-grid">
            <div class="summary-card bug">
                <div class="count">2</div>
                <div class="label">Bugs</div>
                <div class="sublabel">Must Fix</div>
            </div>
            <div class="summary-card risk">
                <div class="count">4</div>
                <div class="label">Risks</div>
                <div class="sublabel">Should Address</div>
            </div>
            <div class="summary-card style">
                <div class="count">5</div>
                <div class="label">Style</div>
                <div class="sublabel">Consider</div>
            </div>
        </div>

        <div class="info-notice">
            <div class="info-header">
                <span class="info-icon">‚ö°</span>
                <h3>Execution Order Reference</h3>
            </div>
            <p>Understanding execution order is critical for identifying real bugs vs valid patterns:</p>
            <ul>
                <li><strong>1. Expressions execute first:</strong> All expressions in <code>before_reasoning</code> AND <code>instructions</code> run top-to-bottom BEFORE the LLM sees anything.</li>
                <li><strong>2. Pipe content becomes prompt:</strong> Only <code>|</code> content goes to the LLM. Expressions are NOT part of the prompt.</li>
                <li><strong>3. LLM reasoning:</strong> LLM processes the prompt and may choose to call actions.</li>
                <li><strong>4. after_reasoning:</strong> Runs after LLM completes. Variables set during reasoning may not be populated yet.</li>
            </ul>
        </div>

        <div class="section-header">
            <h2>üéØ Script Intent</h2>
            <p>What this agent is designed to do</p>
        </div>

        <div class="issue-card">
            <div class="issue-content">
                <p><strong>RestaurantScriptAgent3</strong> is an OpenTable support agent designed to:</p>
                <ol style="margin-left: 20px; color: var(--text-secondary);">
                    <li><strong>Welcome & Route</strong> ‚Äî Greet users and classify intent to appropriate topic</li>
                    <li><strong>Pre-Escalation</strong> ‚Äî Gather issue description, offer Ticket or Phone options</li>
                    <li><strong>Create Case</strong> ‚Äî Collect user details and create support case via Flow</li>
                    <li><strong>Escalate</strong> ‚Äî Transfer to human agent after case creation</li>
                    <li><strong>Knowledge Topics</strong> ‚Äî Answer reservation and general questions via knowledge base</li>
                </ol>
            </div>
        </div>
    </section>

    <section class="container diagram-section">
        <div class="section-header">
            <h2>üîÄ Current Logic Flow</h2>
            <p>Visual representation ‚Äî red nodes indicate bugs, orange indicates risks</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('current')">Current Flow (with issues)</button>
            <button class="tab" onclick="showTab('fixed')">Fixed Flow</button>
        </div>

        <div id="current" class="tab-content active">
            <div class="diagram-container">
                <div class="mermaid">
flowchart TD
    subgraph Entry["Entry"]
        A["User Message"] --> B["start_agent Topic_Selector"]
    end
    
    subgraph TopicSelector["Topic_Selector"]
        B --> C{"Check current_topic variable"}
        C -->|"current_topic == Pre_Escalation"| D["transition to Pre_Escalation"]
        C -->|"Otherwise"| E{"LLM Classifies Intent"}
        E -->|"Escalation/Human/Issue"| F["go_to_Pre_Escalation"]
        E -->|"Reservation"| G["go_to_Reservation"]
        E -->|"General"| H["go_to_General"]
    end
    
    subgraph PreEsc["Pre_Escalation_Management"]
        F --> I["Set current_topic"]
        D --> I
        I --> J["Gather Description"]
        J --> K["Offer: Ticket or Phone"]
        K --> L{"LLM calls setVariables?"}
        L -->|"Yes Ticket"| M["UserSelection = Ticket"]
        L -->|"Yes Phone"| N["UserSelection = Phone"]
        L -->|"No"| O["Variables Empty"]
        M --> P["after_reasoning checks"]
        N --> P
        O --> P
        P -->|"Ticket"| Q["to Create_a_Case"]
        P -->|"Phone"| R["Get Phone"]
        P -->|"Empty"| S["STUCK"]
    end
    
    subgraph CreateCase["Create_a_Case"]
        Q --> T["LLM gathers 5+ fields"]
        T --> U{"Create action called?"}
        U -->|"Yes"| V["Case Created"]
        U -->|"No"| W["Failure"]
        V --> X["after_reasoning checks"]
        X -->|"True"| Y["to Escalation"]
        X -->|"False"| Z["STUCK"]
    end
    
    subgraph Knowledge["Knowledge Topics"]
        G --> AC["Search KB"]
        H --> AC
        AC --> AD["Return Answer"]
    end
    
    style S fill:#ff4757,stroke:#333,color:#fff
    style W fill:#ff4757,stroke:#333,color:#fff
    style Z fill:#ff4757,stroke:#333,color:#fff
    style O fill:#ffa502,stroke:#333,color:#000
    style C fill:#ffa502,stroke:#333,color:#000
                </div>
            </div>
        </div>

        <div id="fixed" class="tab-content">
            <div class="diagram-container">
                <div class="mermaid">
flowchart TD
    subgraph Entry["Entry"]
        A["User Message"] --> B["Topic_Selector"]
    end
    
    subgraph TopicSelector["Topic_Selector"]
        B --> C{"LLM Classifies Intent"}
        C -->|"Support/Issue"| D["go_to_support"]
        C -->|"Reservation"| E["go_to_reservations"]
        C -->|"General"| F["go_to_general"]
    end
    
    subgraph PreEsc["Pre_Escalation"]
        D --> G["Gather Description"]
        G --> H{"Clear?"}
        H -->|"No"| G
        H -->|"Yes"| I["Mark Billing if mentioned"]
        I --> J["Offer Options"]
        J --> K{"User Choice"}
        K -->|"Ticket"| L["go_to_ticket action"]
        K -->|"Phone"| M["get_phone action"]
    end
    
    subgraph GatherInfo["Gather_Case_Info"]
        L --> O{"Has Required Data?"}
        O -->|"Yes"| P["Skip to Create"]
        O -->|"No"| Q["Collect Info"]
        Q --> R{"Complete?"}
        R -->|"No"| Q
        R -->|"Yes"| S["proceed_to_case"]
    end
    
    subgraph CreateCase["Create_Case"]
        P --> T{"Validate Data"}
        S --> T
        T -->|"Valid"| U["Create Case"]
        U --> V["to Escalation"]
    end
    
    subgraph Escalation["Escalation"]
        V --> W["Inform User"]
        W --> X{"Want Agent?"}
        X -->|"Yes"| Y["escalate_to_human"]
    end
    
    subgraph Knowledge["Knowledge Topics"]
        E --> Z1["Reservation_Knowledge"]
        F --> Z2["General_Knowledge"]
        Z1 --> Z3["search_knowledge"]
        Z2 --> Z3
        Z3 --> Z4["Return Answer"]
    end
    
    style L fill:#26de81,stroke:#333,color:#000
    style M fill:#26de81,stroke:#333,color:#000
    style S fill:#26de81,stroke:#333,color:#000
    style V fill:#26de81,stroke:#333,color:#000
                </div>
            </div>
        </div>
    </section>

    <section class="container issues-section">
        <div class="section-header">
            <h2>üî¥ Bugs (Must Fix)</h2>
            <p>These will cause the script to fail or behave incorrectly</p>
        </div>

        <div class="issue-card">
            <div class="issue-header">
                <span class="issue-badge bug">Bug</span>
                <div class="issue-title">
                    <h3>Same-Turn Variable Race Condition</h3>
                    <span class="location">Lines 131-152 ‚Äî Pre_Escalation_Management</span>
                </div>
            </div>
            <div class="issue-content">
                <p><strong>Problem:</strong> Variables are set during reasoning AND checked in <code>after_reasoning</code> of the SAME turn. The action may not have completed, so variables may be null.</p>

<pre><span class="code-comment"># During reasoning, LLM may call this action:</span>
<span class="code-keyword">set_UserSelection_to_Ticket:</span> <span class="code-variable">@utils.setVariables</span>
    <span class="code-keyword">with</span> UserSelection = <span class="code-string">"Ticket"</span>

<span class="code-comment"># Then after_reasoning checks the variable:</span>
<span class="code-keyword">after_reasoning:</span>
    <span class="code-keyword">if</span> <span class="code-variable">@variables.UserSelection</span> == <span class="code-string">"Ticket"</span>:  <span class="code-comment"># May be null!</span>
        <span class="code-keyword">transition to</span> <span class="code-variable">@topic.Create_a_Case</span></pre>

                <p><strong>Why it fails:</strong> Execution order is: expressions ‚Üí LLM reasoning ‚Üí LLM may call actions ‚Üí after_reasoning. When after_reasoning runs, the setVariables action from reasoning may not have completed yet.</p>

                <p><strong>Impact:</strong> Users get stuck in Pre_Escalation_Management. The transition never fires because UserSelection is still empty.</p>

                <div class="alternatives-box">
                    <h4>üîß Fix Options (both valid)</h4>
                    <p><strong>Option A: Transition as Action</strong> ‚Äî More deterministic, transition happens when action is called:</p>
<pre><span class="code-keyword">actions:</span>
    <span class="code-variable">go_to_ticket:</span> <span class="code-variable">@utils.transition to @topic.Create_a_Case</span>
        <span class="code-keyword">description:</span> <span class="code-string">"User chose ticket"</span></pre>
                    <p style="margin-top: 16px;"><strong>Option B: Check in Next Turn</strong> ‚Äî More flexible, keeps setVariables pattern:</p>
<pre><span class="code-comment"># In Create_a_Case topic (next turn):</span>
<span class="code-keyword">reasoning:</span>
    <span class="code-keyword">instructions:</span> ->
        <span class="code-keyword">if</span> <span class="code-variable">@variables.UserSelection</span> == <span class="code-string">""</span>:
            <span class="code-keyword">transition to</span> <span class="code-variable">@topic.Pre_Escalation</span>
        <span class="code-comment"># Now UserSelection is reliably set</span></pre>
                </div>
            </div>
        </div>

        <div class="issue-card">
            <div class="issue-header">
                <span class="issue-badge bug">Bug</span>
                <div class="issue-title">
                    <h3>Manual Topic Tracking Variable</h3>
                    <span class="location">Line 32 ‚Äî Variables block</span>
                </div>
            </div>
            <div class="issue-content">
                <p><strong>Problem:</strong> The script maintains a <code>current_topic</code> variable to track which topic is active. The framework already manages this internally.</p>

<pre>current_topic: <span class="code-keyword">mutable string</span>
    <span class="code-keyword">label:</span> <span class="code-string">"current_topic"</span></pre>

                <p><strong>Why it's a bug:</strong> This variable is used in Topic_Selector routing logic (lines 73-74). When it gets out of sync with the framework's actual topic state, routing breaks.</p>

                <div class="fix-box">
                    <h4>‚úÖ Fix</h4>
                    <p>Remove <code>current_topic</code> variable entirely. Use topic transitions and let the framework manage state. The framework automatically returns to <code>start_agent</code> when needed.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="container issues-section">
        <div class="section-header">
            <h2>üü† Risks (Should Address)</h2>
            <p>These may cause unreliable behavior</p>
        </div>

        <div class="issue-card">
            <div class="issue-header">
                <span class="issue-badge risk">Risk</span>
                <div class="issue-title">
                    <h3>Excessive Slot-Fill Parameters</h3>
                    <span class="location">Lines 196-215 ‚Äî Create_a_Case</span>
                </div>
            </div>
            <div class="issue-content">
                <p><strong>Problem:</strong> Two actions with 8+ combined slot-fill parameters (<code>...</code>). The LLM must extract all values correctly in a single turn.</p>
                <p><strong>Risk:</strong> Higher chance of missing or hallucinated values. Not a guaranteed failure, but reliability decreases with more slot-fills.</p>
                <div class="fix-box">
                    <h4>‚úÖ Mitigation</h4>
                    <p>Separate data gathering into a dedicated topic. Collect one or two values at a time, then bind them (instead of slot-filling) in the case creation action.</p>
                </div>
            </div>
        </div>

        <div class="issue-card">
            <div class="issue-header">
                <span class="issue-badge risk">Risk</span>
                <div class="issue-title">
                    <h3>Inconsistent Data Flow</h3>
                    <span class="location">Lines 203-215 ‚Äî Create_a_Case action</span>
                </div>
            </div>
            <div class="issue-content">
                <p><strong>Problem:</strong> SetCaseDetails captures values into variables, but the case creation action slot-fills them again instead of binding.</p>
<pre><span class="code-comment"># SetCaseDetails captures:</span>
<span class="code-keyword">with</span> user_email = ...

<span class="code-comment"># But case creation re-slot-fills:</span>
<span class="code-keyword">with</span> INPUT_EMAIL = ...  <span class="code-comment"># Should be: @variables.user_email</span></pre>
                <p><strong>Risk:</strong> LLM may extract different values the second time, causing inconsistency.</p>
            </div>
        </div>

        <div class="issue-card">
            <div class="issue-header">
                <span class="issue-badge risk">Risk</span>
                <div class="issue-title">
                    <h3>Duplicate Action Definitions</h3>
                    <span class="location">Lines 372-412 and 438-478</span>
                </div>
            </div>
            <div class="issue-content">
                <p><strong>Problem:</strong> <code>Answer_Restaurant_Questions_With_Knowledge</code> is defined identically in both Reservation and General topics.</p>
                <p><strong>Risk:</strong> Maintenance burden. Changes must be made in two places. Definitions may drift apart over time.</p>
            </div>
        </div>

        <div class="issue-card">
            <div class="issue-header">
                <span class="issue-badge risk">Risk</span>
                <div class="issue-title">
                    <h3>No Precondition Validation</h3>
                    <span class="location">Topic Create_a_Case</span>
                </div>
            </div>
            <div class="issue-content">
                <p><strong>Problem:</strong> No check that required data exists before attempting case creation.</p>
                <p><strong>Risk:</strong> Case creation may fail if user somehow reaches this topic without providing required info.</p>
            </div>
        </div>
    </section>

    <section class="container issues-section">
        <div class="section-header">
            <h2>üîµ Style Notes (Consider)</h2>
            <p>Valid patterns with tradeoffs ‚Äî not wrong, just alternatives to consider</p>
        </div>

        <div class="issue-card">
            <div class="issue-header">
                <span class="issue-badge style">Style</span>
                <div class="issue-title">
                    <h3>Missing Action Descriptions</h3>
                    <span class="location">Lines 87-89</span>
                </div>
            </div>
            <div class="issue-content">
                <p>Transition actions lack descriptions. Adding them helps the LLM distinguish when to use each.</p>
            </div>
        </div>

        <div class="issue-card">
            <div class="issue-header">
                <span class="issue-badge style">Style</span>
                <div class="issue-title">
                    <h3>Typo in Input Name</h3>
                    <span class="location">Lines 209, 265</span>
                </div>
            </div>
            <div class="issue-content">
                <p><code>INPUT_RESTATURANT_NAME</code> ‚Äî Note "RESTATURANT" instead of "RESTAURANT". Verify this matches the Flow definition.</p>
            </div>
        </div>

        <div class="issue-card">
            <div class="issue-header">
                <span class="issue-badge style">Style</span>
                <div class="issue-title">
                    <h3>Inconsistent Naming Conventions</h3>
                    <span class="location">Variables block</span>
                </div>
            </div>
            <div class="issue-content">
                <p>Mixed conventions: <code>UserDescription</code> (PascalCase), <code>user_email</code> (snake_case), <code>OUTPUT_TICKET_CREATED</code> (SCREAMING_SNAKE). Consider standardizing.</p>
            </div>
        </div>

        <div class="issue-card">
            <div class="issue-header">
                <span class="issue-badge style">Style</span>
                <div class="issue-title">
                    <h3>Unused Variables</h3>
                    <span class="location">Lines 16, 28</span>
                </div>
            </div>
            <div class="issue-content">
                <p><code>Case_Created</code> and <code>HasOnlineAgents</code> are declared but never used.</p>
            </div>
        </div>

        <div class="issue-card">
            <div class="issue-header">
                <span class="issue-badge style">Style</span>
                <div class="issue-title">
                    <h3>Default Value "temp"</h3>
                    <span class="location">Line 34</span>
                </div>
            </div>
            <div class="issue-content">
                <p><code>user_full_name: mutable string = "temp"</code> ‚Äî Empty string would be cleaner.</p>
            </div>
        </div>
    </section>

    <section class="container">
        <div class="positive-section">
            <h3>‚úÖ Positive Observations</h3>
            <ul class="positive-list">
                <li><strong>Proper connection block</strong> ‚Äî Escalation configured correctly with OmniChannel</li>
                <li><strong>Complete action definitions</strong> ‚Äî All required inputs/outputs properly defined</li>
                <li><strong>Good topic descriptions</strong> ‚Äî Topics have clear, descriptive labels</li>
                <li><strong>Linked variables</strong> ‚Äî Session context properly linked from MessagingSession</li>
                <li><strong>Knowledge integration</strong> ‚Äî Proper use of generatePromptResponse for knowledge search</li>
                <li><strong>Clear user flow</strong> ‚Äî The intended ticket/phone decision flow is well-structured</li>
            </ul>
        </div>
    </section>

    <section class="container">
        <div class="section-header">
            <h2>üìÑ Suggested Fixes</h2>
            <p>One approach to fixing the bugs ‚Äî other valid approaches exist</p>
        </div>

        <div class="solution-section">
            <div class="solution-header">
                <h3>Key Changes</h3>
                <p>These address the two bugs while preserving the script's structure.</p>
            </div>

            <div class="feature-grid">
                <div class="feature-item">
                    <span class="feature-icon">üîß</span>
                    <div class="feature-text">
                        <strong>Fix Race Condition</strong>
                        <span>Either: transition as action, OR check variables in next turn</span>
                    </div>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üóëÔ∏è</span>
                    <div class="feature-text">
                        <strong>Remove current_topic</strong>
                        <span>Let framework manage topic state</span>
                    </div>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üìã</span>
                    <div class="feature-text">
                        <strong>Add Preconditions</strong>
                        <span>Validate data before case creation</span>
                    </div>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üîó</span>
                    <div class="feature-text">
                        <strong>Bind Captured Values</strong>
                        <span>Use @variables instead of re-slot-filling</span>
                    </div>
                </div>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span>Pre_Escalation ‚Äî Fixed Race Condition (Option A: Transition as Action)</span>
                    <button class="copy-btn" onclick="copyCode()">üìã Copy</button>
                </div>
                <pre id="agent-code"><code>topic Pre_Escalation:
    label: "Pre-Escalation Support"
    description: "Gather issue description and offer resolution options"

    reasoning:
        instructions: ->
            | Help the user describe their issue and choose how to proceed.
            | Once they provide a clear description, offer: Ticket or Phone.
            | Use the appropriate action based on their choice.

        actions:
            capture_description: @utils.setVariables
                description: "Save the user's issue description"
                with user_description = ...

            mark_billing: @utils.setVariables
                description: "Mark billing mentioned (billing, payment, invoice, charge)"
                with mentioned_billing = True

            # FIX: Transition IS the action - no race condition
            go_to_ticket: @utils.transition to @topic.Gather_Case_Info
                description: "User chose to submit a ticket"

            get_phone_number: @actions.Get_Support_Number
                description: "User chose phone support"
                with EndUserLanguage = @variables.end_user_language
                set @variables.support_number = @outputs.SupportPhoneNumber

# Alternative Fix (Option B): Keep setVariables, check in next topic
# topic Gather_Case_Info:
#     reasoning:
#         instructions: ->
#             if @variables.UserSelection == "":
#                 transition to @topic.Pre_Escalation
#             | Collect required information...</code></pre>
            </div>
        </div>
    </section>

    <footer class="footer">
        <p>Generated by Claude ¬∑ Verified against <a href="https://developer.salesforce.com/docs/ai/agentforce/guide/agent-script.html" target="_blank">Salesforce Developer Documentation</a></p>
        <p style="margin-top: 8px;">Agent Script is currently in Beta ¬∑ 15 January 2026</p>
    </footer>

    <script>
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#3742fa',
                primaryTextColor: '#e8e8ec',
                primaryBorderColor: '#2a2a3a',
                lineColor: '#55556a',
                secondaryColor: '#1a1a25',
                tertiaryColor: '#12121a',
                background: '#12121a',
                mainBkg: '#12121a',
                nodeBorder: '#2a2a3a',
                clusterBkg: '#1a1a25',
                clusterBorder: '#2a2a3a',
                titleColor: '#e8e8ec',
                edgeLabelBackground: '#12121a'
            },
            flowchart: { curve: 'basis', padding: 20 }
        });

        const renderedTabs = new Set();

        async function renderMermaidIn(container) {
            const mermaidDivs = container.querySelectorAll('.mermaid');
            for (const div of mermaidDivs) {
                if (div.getAttribute('data-processed')) continue;
                const graphDefinition = div.textContent;
                const { svg } = await mermaid.render('mermaid-' + Math.random().toString(36).substr(2, 9), graphDefinition);
                div.innerHTML = svg;
                div.setAttribute('data-processed', 'true');
            }
        }

        async function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            const tabContent = document.getElementById(tabId);
            tabContent.classList.add('active');
            event.target.classList.add('active');

            if (!renderedTabs.has(tabId)) {
                await renderMermaidIn(tabContent);
                renderedTabs.add(tabId);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                await renderMermaidIn(activeTab);
                renderedTabs.add(activeTab.id);
            }
        });

        function copyCode() {
            const code = document.getElementById('agent-code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => { btn.textContent = 'üìã Copy'; }, 2000);
            });
        }
    </script>
</body>
</html>